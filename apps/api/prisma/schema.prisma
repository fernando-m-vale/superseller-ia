// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  owner
  manager
  operator
}

enum Marketplace {
  shopee
  mercadolivre
  amazon
  magalu
}

enum ConnectionStatus {
  active
  expired
  revoked
}

enum ListingStatus {
  active
  paused
  deleted
}

enum QualityStatus {
  pass
  warning
  critical
}

enum JobStatus {
  success
  error
  running
}

enum JobType {
  shopee_sync
  mercadolivre_sync
  mercadolivre_orders_sync
  amazon_sync
  magalu_sync
  metrics_aggregation
  data_quality_check
}

enum OrderStatus {
  pending
  paid
  shipped
  delivered
  cancelled
  refunded
}

enum RuleStatus {
  active
  inactive
}

enum ActionType {
  title_optimization
  image_audit
  attribute_completion
  price_adjustment
  stock_update
}

enum RecommendationType {
  seo // Otimização de título/descrição
  image // Melhoria de imagens
  price // Ajuste de preço
  conversion // Melhoria de conversão
  stock // Gestão de estoque
  content // Conteúdo geral
}

enum RecommendationStatus {
  pending // Aguardando ação do usuário
  applied // Usuário aplicou a recomendação
  dismissed // Usuário ignorou
  expired // Expirou (anúncio mudou)
}

// Models
model Tenant {
  id         String   @id @default(uuid())
  name       String
  created_at DateTime @default(now())

  users                   User[]
  marketplace_connections MarketplaceConnection[]
  listings                Listing[]
  orders                  Order[]
  listing_metrics_daily   ListingMetricsDaily[]
  ai_model_metrics        AiModelMetric[]
  data_quality_checks     DataQualityCheck[]
  job_logs                JobLog[]
  auto_approve_rules      AutoApproveRule[]
  listing_action_outcomes ListingActionOutcome[]
  recommendations         Recommendation[]

  @@map("tenants")
}

model User {
  id            String   @id @default(uuid())
  tenant_id     String
  email         String   @unique
  password_hash String
  role          UserRole
  created_at    DateTime @default(now())

  tenant Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@index([tenant_id])
  @@map("users")
}

model MarketplaceConnection {
  id                  String           @id @default(uuid())
  tenant_id           String
  type                Marketplace
  provider_account_id String
  access_token        String
  refresh_token       String?
  expires_at          DateTime?
  status              ConnectionStatus
  created_at          DateTime         @default(now())
  updated_at          DateTime         @updatedAt

  tenant Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@unique([tenant_id, type, provider_account_id])
  @@index([tenant_id])
  @@map("marketplace_connections")
}

model Listing {
  id                 String        @id @default(uuid())
  tenant_id          String
  marketplace        Marketplace
  listing_id_ext     String
  title              String
  description        String? // Descrição do anúncio para análise
  price              Decimal       @db.Decimal(10, 2)
  stock              Int
  status             ListingStatus
  category           String?
  health_score       Float?        @default(0) // Score legado da API do ML (0-100)
  super_seller_score Int?          @default(0) // Super Seller Score proprietário (0-100)
  score_breakdown    Json? // Detalhamento: { cadastro: 25, trafego: 20, disponibilidade: 35 }
  thumbnail_url      String? // URL da imagem principal
  pictures_count     Int?          @default(0) // Quantidade de fotos
  has_video          Boolean?      @default(false) // Tem vídeo? (baseado em video_id/videos do payload)
  has_clips          Boolean? // Tem clips? (null = desconhecido/não detectável via API)
  clips_source       String? // Fonte: "unknown" | "override" | "api"
  clips_checked_at   DateTime? // Quando foi verificado/atualizado
  visits_last_7d     Int?          @default(0) // Visitas últimos 7 dias
  sales_last_7d      Int?          @default(0) // Vendas últimos 7 dias
  created_at         DateTime      @default(now())
  updated_at         DateTime      @updatedAt

  tenant                  Tenant                 @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  listing_metrics_daily   ListingMetricsDaily[]
  listing_action_outcomes ListingActionOutcome[]
  order_items             OrderItem[]
  recommendations         Recommendation[]

  @@unique([tenant_id, marketplace, listing_id_ext])
  @@index([tenant_id])
  @@index([tenant_id, marketplace])
  @@index([tenant_id, status])
  @@index([super_seller_score])
  @@map("listings")
}

model Order {
  id             String      @id @default(uuid())
  tenant_id      String
  marketplace    Marketplace
  order_id_ext   String // ID do pedido no marketplace (ex: ML order ID)
  status         OrderStatus
  total_amount   Decimal     @db.Decimal(12, 2)
  currency       String      @default("BRL")
  buyer_nickname String?
  buyer_id_ext   String? // ID do comprador no marketplace
  shipping_cost  Decimal?    @db.Decimal(10, 2)
  order_date     DateTime // Data do pedido no marketplace
  paid_date      DateTime? // Data do pagamento
  shipped_date   DateTime? // Data de envio
  delivered_date DateTime? // Data de entrega
  created_at     DateTime    @default(now())
  updated_at     DateTime    @updatedAt

  tenant Tenant      @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  items  OrderItem[]

  @@unique([tenant_id, marketplace, order_id_ext])
  @@index([tenant_id])
  @@index([tenant_id, marketplace])
  @@index([tenant_id, status])
  @@index([order_date])
  @@map("orders")
}

model OrderItem {
  id             String   @id @default(uuid())
  order_id       String
  listing_id     String? // Pode ser null se o listing foi deletado
  listing_id_ext String // ID do item no marketplace
  title          String
  quantity       Int
  unit_price     Decimal  @db.Decimal(10, 2)
  total_price    Decimal  @db.Decimal(10, 2)
  created_at     DateTime @default(now())

  order   Order    @relation(fields: [order_id], references: [id], onDelete: Cascade)
  listing Listing? @relation(fields: [listing_id], references: [id], onDelete: SetNull)

  @@index([order_id])
  @@index([listing_id])
  @@map("order_items")
}

model ListingMetricsDaily {
  id          String   @id @default(uuid())
  tenant_id   String
  listing_id  String
  date        DateTime @db.Date
  impressions Int
  clicks      Int
  ctr         Decimal  @db.Decimal(5, 4)
  visits      Int
  conversion  Decimal  @db.Decimal(5, 4)
  orders      Int
  gmv         Decimal  @db.Decimal(10, 2)
  source      String?  // Origem dos dados: 'ml_metrics_api' | 'ml_orders' | 'estimate' | 'ml_items_aggregate'
  created_at  DateTime @default(now())

  tenant  Tenant  @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  listing Listing @relation(fields: [listing_id], references: [id], onDelete: Cascade)

  @@unique([tenant_id, listing_id, date])
  @@index([tenant_id])
  @@index([listing_id])
  @@index([date])
  @@map("listing_metrics_daily")
}

model AiModelMetric {
  id            String   @id @default(uuid())
  tenant_id     String
  model_version String   @default("v1.1")
  mae           Decimal  @db.Decimal(10, 4)
  rmse          Decimal  @db.Decimal(10, 4)
  r_squared     Decimal  @db.Decimal(5, 4)
  training_date DateTime
  samples_count Int
  features_used String[]
  metadata      Json?
  created_at    DateTime @default(now())

  tenant Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@index([tenant_id])
  @@index([model_version])
  @@index([training_date])
  @@map("ai_model_metrics")
}

model DataQualityCheck {
  id               String        @id @default(uuid())
  tenant_id        String
  check_date       DateTime      @db.Date
  status           QualityStatus
  missing_days     Int           @default(0)
  outlier_count    Int           @default(0)
  total_listings   Int
  listings_checked Int
  issues_found     Json?
  created_at       DateTime      @default(now())

  tenant Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@unique([tenant_id, check_date])
  @@index([tenant_id])
  @@index([check_date])
  @@index([status])
  @@map("data_quality_checks")
}

model JobLog {
  id                String    @id @default(uuid())
  tenant_id         String
  job_type          JobType
  status            JobStatus
  started_at        DateTime
  completed_at      DateTime?
  duration_ms       Int?
  records_processed Int?
  error_message     String?
  metadata          Json?
  created_at        DateTime  @default(now())

  tenant Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@index([tenant_id])
  @@index([job_type])
  @@index([status])
  @@index([started_at])
  @@map("job_logs")
}

model AutoApproveRule {
  id                 String     @id @default(uuid())
  tenant_id          String
  name               String
  description        String?
  status             RuleStatus @default(active)
  ctr_threshold      Decimal?   @db.Decimal(5, 4)
  cvr_threshold      Decimal?   @db.Decimal(5, 4)
  revenue_impact_min Decimal?   @db.Decimal(10, 2)
  dry_run            Boolean    @default(true)
  created_at         DateTime   @default(now())
  updated_at         DateTime   @updatedAt

  tenant Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@index([tenant_id])
  @@index([status])
  @@map("auto_approve_rules")
}

model ListingActionOutcome {
  id                  String     @id @default(uuid())
  tenant_id           String
  listing_id          String
  action_id           String
  action_type         ActionType
  executed_at         DateTime
  ctr_before          Decimal?   @db.Decimal(5, 4)
  ctr_after           Decimal?   @db.Decimal(5, 4)
  cvr_before          Decimal?   @db.Decimal(5, 4)
  cvr_after           Decimal?   @db.Decimal(5, 4)
  revenue_before      Decimal?   @db.Decimal(10, 2)
  revenue_after       Decimal?   @db.Decimal(10, 2)
  effectiveness_score Decimal?   @db.Decimal(5, 2)
  created_at          DateTime   @default(now())

  tenant  Tenant  @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  listing Listing @relation(fields: [listing_id], references: [id], onDelete: Cascade)

  @@unique([tenant_id, action_id])
  @@index([tenant_id])
  @@index([listing_id])
  @@index([action_type])
  @@index([executed_at])
  @@map("listing_action_outcomes")
}

model Recommendation {
  id              String               @id @default(uuid())
  tenant_id       String
  listing_id      String
  type            RecommendationType
  status          RecommendationStatus @default(pending)
  priority        Int                  @default(50) // 1-100, maior = mais urgente
  title           String // Ex: "Melhore a qualidade das imagens"
  description     String // Descrição detalhada da ação
  impact_estimate String? // Ex: "+15% conversão esperada"
  rule_trigger    String? // Ex: "pictures_count < 3"
  score_impact    Int? // Quantos pontos o anúncio pode ganhar
  metadata        Json? // Dados extras para a UI
  applied_at      DateTime? // Quando foi aplicada
  dismissed_at    DateTime? // Quando foi ignorada
  created_at      DateTime             @default(now())
  updated_at      DateTime             @updatedAt

  tenant  Tenant  @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  listing Listing @relation(fields: [listing_id], references: [id], onDelete: Cascade)

  @@unique([tenant_id, listing_id, type, rule_trigger]) // Evita duplicatas
  @@index([tenant_id])
  @@index([listing_id])
  @@index([tenant_id, status])
  @@index([type])
  @@index([priority])
  @@map("recommendations")
}
